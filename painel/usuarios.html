<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerenciar Usu√°rios - Painel Admin</title>
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <script>
    const supabaseUrl = 'https://hylttfhaedvytykjpeze.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5bHR0ZmhhZWR2eXR5a2pwZXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTE1MDgsImV4cCI6MjA3NDI4NzUwOH0.e0BmMYbBC9QBI6TNsKgWUckFqCPnjPGEAq6-7h1W18A';
    const supa = supabase.createClient(supabaseUrl, supabaseKey);
    window.supabase = window.supabase || supa;

    let currentUserRole = null; // Vari√°vel para guardar a role do usu√°rio logado
    const guardAdmin = async () => {
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = '../login.html'; return; }
      const { data: profile } = await supa
        .from('profiles')
        .select('role')
        .eq('id', session.user.id)
        .single();
      currentUserRole = profile?.role; // Armazena a role
      if (!profile || profile.role !== 'admin') {
        await supa.auth.signOut();
        alert('Acesso negado.');
        window.location.href = '../index.html';
      }
    };

    guardAdmin();
  </script>

  <div class="app" id="app">
    <aside>
      <div class="brand">
        <div class="avatar">MA</div>
        <div>
          <div class="username">Moda Online</div>
          <div style="font-size:12px;color:var(--muted)">admin</div>
        </div>
      </div>
      <nav>
        <div class="nav-item" onclick="window.location.href='admin.html'">‚üµ Voltar</div>
      </nav>
      <button class="logout" id="btnLogout">üö™ Sair</button>
    </aside>

    <main>
      <header>
        <h1>Gerenciar Usu√°rios</h1>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="online">Online</div>
          <div style="width:34px;height:34px;border-radius:50%;background:#dbeafe"></div>
        </div>
      </header>

      <section class="page active">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="width:60%">
              <p style="margin:0;color:var(--muted)">Liste, busque, pagine, altere pap√©is e remova usu√°rios.</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn green" id="btnOpenAddUser">+ Adicionar Usu√°rio</button>
              <input id="searchInput" type="text" placeholder="Buscar por nome ou email" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px">
              <button class="btn grey" id="btnSearch">Buscar</button>
              <button class="btn" id="btnClear">Limpar</button>
              <button class="btn" id="btnReload">Recarregar</button>
              <div style="display:flex;gap:6px;align-items:center">
                <span style="color:var(--muted);font-size:13px">Por p√°gina</span>
                <select id="pageSize" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
          </div>

          <table class="table" style="margin-top:16px">
            <thead>
              <tr>
                <th>NOME</th>
                <th>EMAIL</th>
                <th>PAPEL</th>
                <th>STATUS</th>
                <th style="width: 250px;">A√á√ïES</th>
              </tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>

          <div id="usersEmpty" class="empty" style="display:none;">
            <div style="font-size:34px">üë•</div>
            <div style="margin-top:8px;font-weight:700">Nenhum usu√°rio encontrado</div>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div id="resultsInfo" style="color:var(--muted);font-size:13px"></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn grey" id="btnPrev">Anterior</button>
              <span id="pageIndicator" style="min-width:90px;text-align:center"></span>
              <button class="btn grey" id="btnNext">Pr√≥xima</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Adicionar Usu√°rio -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Adicionar Usu√°rio</h2>
        <span class="close-button" id="closeAddUser">√ó</span>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="form-row">
            <div style="flex:1">
              <label for="auName">Nome completo</label>
              <input type="text" id="auName" placeholder="Ex: Maria Almeida" required>
            </div>
            <div style="flex:1">
              <label for="auEmail">Email</label>
              <input type="text" id="auEmail" placeholder="email@dominio.com" required>
            </div>
          </div>
          <div class="form-row">
            <div style="flex:1">
              <label for="auPassword">Senha inicial</label>
              <input type="text" id="auPassword" placeholder="Defina uma senha tempor√°ria" required>
            </div>
            <div style="flex:1">
              <label for="auRole">Papel</label>
              <select id="auRole">
                <option value="user">Usu√°rio</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div style="flex:1">
              <label for="auStatus">Status</label>
              <select id="auStatus">
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="justify-content:flex-end">
            <button type="button" class="btn" id="btnCancelAddUser">Cancelar</button>
            <button type="submit" class="btn green" id="btnSubmitAddUser">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const usersBody = document.getElementById('usersBody');
    const usersEmpty = document.getElementById('usersEmpty');
    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');
    const btnReload = document.getElementById('btnReload');
    const pageSizeEl = document.getElementById('pageSize');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageIndicator = document.getElementById('pageIndicator');
    const resultsInfo = document.getElementById('resultsInfo');
    // Modal elements
    const addUserModal = document.getElementById('addUserModal');
    const btnOpenAddUser = document.getElementById('btnOpenAddUser');
    const btnCancelAddUser = document.getElementById('btnCancelAddUser');
    const closeAddUser = document.getElementById('closeAddUser');
    const addUserForm = document.getElementById('addUserForm');
    const auName = document.getElementById('auName');
    const auEmail = document.getElementById('auEmail');
    const auPassword = document.getElementById('auPassword');
    const auRole = document.getElementById('auRole');
    const auStatus = document.getElementById('auStatus');
    const btnSubmitAddUser = document.getElementById('btnSubmitAddUser');
    // Backend URL (pode sobrescrever via localStorage.setItem('backendUrl', 'http://localhost:3000'))
    const backendUrl = localStorage.getItem('backendUrl') || 'http://localhost:3000';

    let allUsers = [];
    let filteredUsers = [];
    let currentPage = 1;
    let pageSize = parseInt(pageSizeEl ? pageSizeEl.value : '10', 10);

    function renderUsers(rows) {
      usersBody.innerHTML = '';
      if (!rows || rows.length === 0) {
        usersEmpty.style.display = 'flex';
        resultsInfo.textContent = '0 resultados';
        pageIndicator.textContent = '';
        return;
      }
      usersEmpty.style.display = 'none';
      rows.forEach(u => {
        const displayName = u.full_name || u.name || '-';
        const email = u.email || '-';
        const role = u.role || 'user';
        const status = u.status || 'active'; // 'active' ou 'inactive'
        const isCurrentUser = supa.auth.user() && supa.auth.user().id === u.id;
        const canDelete = currentUserRole === 'admin' && !isCurrentUser;

        const tr = document.createElement('tr');

        // C√©lula Nome
        const tdName = document.createElement('td');
        tdName.textContent = displayName;
        tr.appendChild(tdName);

        // C√©lula Email
        const tdEmail = document.createElement('td');
        tdEmail.textContent = email;
        tr.appendChild(tdEmail);

        // C√©lula Papel (Role)
        const tdRole = document.createElement('td');
        tr.innerHTML = `
          <td>${tdName.outerHTML}</td>
          <td>${tdEmail.outerHTML}</td>
          <td>
            <select data-user-id="${u.id}" class="role-select" ${isCurrentUser ? 'disabled' : ''}>
              <option value="user" ${role === 'user' ? 'selected' : ''}>Usu√°rio</option>
              <option value="admin" ${role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </td>
          <td><span class="status-${status}">${status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
          <td>
            <button class="btn grey" onclick="saveRole('${u.id}')" ${isCurrentUser ? 'disabled' : ''}>Salvar Papel</button>
            <button class="btn ${status === 'active' ? 'red' : 'green'}" onclick="toggleUserStatus('${u.id}', '${status}')" ${isCurrentUser ? 'disabled' : ''}>
              ${status === 'active' ? 'Desativar' : 'Ativar'}
            </button>
            <button class="btn red" onclick="deleteUser('${u.id}')" ${!canDelete ? 'disabled' : ''} title="${!canDelete ? 'Apenas administradores podem excluir outros usu√°rios.' : 'Excluir usu√°rio permanentemente'}">
              Excluir
            </button>
          </td>
        `;

        usersBody.appendChild(tr);
      });
    }

    function applyFilter() {
      const term = (searchInput ? searchInput.value : '').trim().toLowerCase();
      if (!term) {
        filteredUsers = [...allUsers];
      } else {
        filteredUsers = allUsers.filter(u => {
          const name = (u.full_name || u.name || '').toLowerCase();
          const email = (u.email || '').toLowerCase();
          return name.includes(term) || email.includes(term);
        });
      }
      currentPage = 1;
      renderPage();
    }

    function renderPage() {
      const total = filteredUsers.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const rows = filteredUsers.slice(start, end);
      renderUsers(rows);
      pageIndicator.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      resultsInfo.textContent = `${total} resultado${total === 1 ? '' : 's'}`;
      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;
    }

    async function loadUsers() {
      try {
        // Primeira tentativa: direto do Supabase (cliente anon)
        const { data, error } = await supa
          .from('profiles')
          .select('id, full_name, email, role, status')
          .order('full_name', { ascending: true });
        if (!error) {
          allUsers = data || [];
          applyFilter();
          return;
        }
        console.warn('Falha no carregamento direto do Supabase, tentando backend...', error);
      } catch (e) {
        console.warn('Exce√ß√£o ao consultar Supabase direto, tentando backend...', e);
      }

      try {
        const { data: { session } } = await supa.auth.getSession();
        const res = await fetch(`${backendUrl}/admin/users`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.accessToken}`
          }
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const json = await res.json();
        allUsers = json.users || [];
        applyFilter();
      } catch (e) {
        console.error('Erro ao carregar usu√°rios via backend:', e);
        alert('N√£o foi poss√≠vel carregar usu√°rios.');
      }
    }

    async function saveRole(userId) {
      const select = document.querySelector(`select.role-select[data-user-id="${userId}"]`);
      if (!select) return;
      const newRole = select.value;
      const { error } = await supa
        .from('profiles')
        .update({ role: newRole })
        .eq('id', userId);
      if (error) {
        console.error('Erro ao salvar papel:', error);
        alert('N√£o foi poss√≠vel atualizar o papel.');
        return;
      }
      alert('Papel atualizado com sucesso!');
      loadUsers();
    }

    async function toggleUserStatus(userId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const actionText = newStatus === 'inactive' ? 'desativar' : 'ativar';

      if (!confirm(`Tem certeza que deseja ${actionText} este usu√°rio?`)) return;

      // Atualiza o status na tabela 'profiles'
      const { error } = await supa
        .from('profiles')
        .update({ status: newStatus })
        .eq('id', userId);

      if (error) {
        console.error(`Erro ao ${actionText} usu√°rio:`, error);
        alert(`N√£o foi poss√≠vel ${actionText} o usu√°rio.`);
        return;
      }

      alert(`Usu√°rio ${actionText} com sucesso!`);
      loadUsers();
    }

    async function deleteUser(userId) {
      if (!confirm('Tem certeza que deseja EXCLUIR PERMANENTEMENTE este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) return;

      // Agora, em vez de chamar uma Supabase Function, chamamos nosso endpoint de backend.
      try {
        // 1. Obter a sess√£o atual para pegar o token de acesso
        const { data: { session } } = await supa.auth.getSession();
        if (!session) {
          alert('Sua sess√£o expirou. Por favor, fa√ßa login novamente.');
          window.location.href = '../login.html';
          return;
        }

        // 2. Fazer a requisi√ß√£o para o backend, incluindo o token no cabe√ßalho
        const response = await fetch(`${backendUrl}/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            // Envia o token JWT para o backend para autentica√ß√£o
            'Authorization': `Bearer ${session.accessToken}`
          }
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.details || result.error || 'Erro desconhecido do servidor.');
        }

        alert(result.message || 'Usu√°rio exclu√≠do com sucesso!');
        loadUsers();

      } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        alert(`N√£o foi poss√≠vel excluir o usu√°rio: ${error.message}. Verifique se o servidor backend est√° rodando.`);
      }
    }

    // --- Adicionar Usu√°rio (Modal) ---
    function openAddUserModal() {
      if (addUserModal) { addUserModal.style.display = 'block'; }
      if (auName) { auName.focus(); }
    }
    function closeAddUserModal() {
      if (addUserModal) { addUserModal.style.display = 'none'; }
      if (addUserForm) { addUserForm.reset(); }
    }

    async function handleAddUserSubmit(e) {
      e.preventDefault();
      const name = (auName?.value || '').trim();
      const email = (auEmail?.value || '').trim();
      const password = (auPassword?.value || '').trim();
      const role = auRole?.value || 'user';
      const status = auStatus?.value || 'active';

      if (!name || !email || !password) {
        alert('Preencha nome, email e senha.');
        return;
      }

      btnSubmitAddUser.disabled = true;
      btnSubmitAddUser.textContent = 'Salvando...';
      try {
        const { data: { session } } = await supa.auth.getSession();
        const res = await fetch(`${backendUrl}/admin/users`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Adiciona o token de autoriza√ß√£o para a rota protegida
            'Authorization': `Bearer ${session?.accessToken}`
          },
          body: JSON.stringify({ full_name: name, email, password, role, status })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          console.error('Erro ao criar usu√°rio:', data);
          alert(data?.error || 'N√£o foi poss√≠vel criar o usu√°rio.');
          return;
        }
        alert('Usu√°rio criado com sucesso!');
        closeAddUserModal();
        loadUsers();
      } catch (err) {
        console.error(err);
        alert('Falha de rede ao criar usu√°rio.');
      } finally {
        btnSubmitAddUser.disabled = false;
        btnSubmitAddUser.textContent = 'Salvar';
      }
    }

    if (btnOpenAddUser) btnOpenAddUser.addEventListener('click', openAddUserModal);
    if (btnCancelAddUser) btnCancelAddUser.addEventListener('click', closeAddUserModal);
    if (closeAddUser) closeAddUser.addEventListener('click', closeAddUserModal);
    if (addUserModal) addUserModal.addEventListener('click', (e) => { if (e.target === addUserModal) closeAddUserModal(); });
    if (addUserForm) addUserForm.addEventListener('submit', handleAddUserSubmit);


    document.getElementById('btnLogout').onclick = async function () {
      const { error } = await supa.auth.signOut();
      if (error) {
        console.error('Erro ao fazer logout:', error);
      }
      window.location.href = '../login.html';
    };

    if (btnSearch) btnSearch.addEventListener('click', applyFilter);
    if (btnClear) btnClear.addEventListener('click', () => { if (searchInput) { searchInput.value = ''; } applyFilter(); });
    if (btnReload) btnReload.addEventListener('click', loadUsers);
    if (pageSizeEl) pageSizeEl.addEventListener('change', () => { pageSize = parseInt(pageSizeEl.value, 10); currentPage = 1; renderPage(); });
    if (btnPrev) btnPrev.addEventListener('click', () => { currentPage -= 1; renderPage(); });
    if (btnNext) btnNext.addEventListener('click', () => { currentPage += 1; renderPage(); });

    loadUsers();
  </script>
</body>

</html>